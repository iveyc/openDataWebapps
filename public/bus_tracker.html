<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map-canvas { height: 100% }
   .labels {
     color: orange;
     background-color: black;
     font-family: "Lucida Grande", "Arial", sans-serif;
     font-size: 10px;
     font-weight: bold;
     text-align: center;
     width: 40px;     
     border: 2px solid black;
     white-space: nowrap;
   }
 </style>
    </style>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.0/jquery.min.js"></script>
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?sensor=true">
    </script>
    <script type="text/javascript" src="/js/markerwithlabel.js"></script>
    <script type="text/javascript">
      // Enable the visual refresh
//google.maps.visualRefresh = true;

var map;
var mapCenter = new google.maps.LatLng(39.951328, -75.168053);
var busNumbers = ["9", "12", "21", "42"];
var busesJson = new Array();
var MY_MAPTYPE_ID = 'philly_style';

function initialize() {
    var featureOpts = [
    {
    stylers: [
      { hue: "#00dde6" },
      { saturation: -50 }
    ]
  },{
    featureType: "road",
    elementType: "geometry",
    stylers: [
      { lightness: 100 },
      { visibility: "simplified" }
    ]
  },{
    featureType: "road",
    elementType: "labels",
    stylers: [
      { visibility: "on" }
    ]
  }
  ];

  var mapOptions = {
    zoom: 15,
    center: mapCenter,
    mapTypeControlOptions: {
      mapTypeIds: [google.maps.MapTypeId.ROADMAP, google.maps.MapTypeId.SATELLITE, MY_MAPTYPE_ID]
    },
    mapTypeId: MY_MAPTYPE_ID
  };
  map = new google.maps.Map(document.getElementById('map-canvas'),
      mapOptions);
  var styledMapOptions = {
      name: 'Philly Style'
  };
  var phillyMapType = new google.maps.StyledMapType(featureOpts, styledMapOptions);
  map.mapTypes.set(MY_MAPTYPE_ID, phillyMapType);

  for (var i=0; i < busNumbers.length; i++) {
    setMarkers(busNumbers[i]);
  }

}



$(document).ready(function() {

    var getArray = [];
    for (var i=0; i < busNumbers.length; i++) {
      getArray.push(getBus(busNumbers[i]));
    }

    $.when.apply(
        $, getArray
      ).done(function(){
        initialize();
      });
    

});


function getBus(busNumber) {
        
    return $.getJSON('/septa/bus/' + busNumber, function(data) {
          busesJson[busNumber] = data;
  });
}

function setMarkers(busNumber) {


  
  for (var i = 0; i < busesJson[busNumber].bus.length; i++) {
    var bus = busesJson[busNumber].bus[i];
    var latLng = new google.maps.LatLng(bus.lat, bus.lng);
    var marker = addMarker(latLng, bus, busNumber);
  }
}

function addMarker(latLng, bus, busNumber) {
    var marker = new MarkerWithLabel({
        position: latLng,
        map: map,
        icon: "images/arrow" + bus.Direction + "24.png",
        title: busNumber + " " + bus.Direction + " to " + bus.destination + " vehicleId " + bus.VehicleID,
        clickable: true,
        draggable: true,
        labelText: busNumber,
        labelClass: "labels", // the CSS class for the label
        labelStyle: {marginTop: "2px", marginLeft: "-21px", opacity: 0.75},
        labelVisible: true
    });
    marker.note = busNumber + " " + bus.Direction + "<br/>To " + bus.destination + "<br/>Vehicle: " + bus.VehicleID
      + "<br/>Last update " + bus.Offset + " min(s) ago<br/>Lat: " + bus.lat + " Lng: " + bus.lng;
    var info_window = new google.maps.InfoWindow({content: ''});
    google.maps.event.addListener(marker, 'click', function() {
        info_window.content = this.note;
        info_window.open(this.getMap(), this);
    });
    return marker;
}


//google.maps.event.addDomListener(window, 'load', initialize);
    </script>
  </head>
  <body>
    <div id="map-canvas" style="width: 100%; height: 100%"></div>
  </body>
</html>